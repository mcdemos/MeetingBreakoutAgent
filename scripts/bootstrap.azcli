#!/bin/bash

# Configuration Variables
RESOURCE_GROUP="MeetingBreakout-RG"
LOCATION="eastus"
RANDOM_ID=$RANDOM
APP_NAME="meeting-breakout-$RANDOM_ID"
SUBSCRIPTION_ID=$(az account show --query id -o tsv)

echo "Bootstrapping Solution: $APP_NAME in $RESOURCE_GROUP ($LOCATION)"

# 1. Create Resource Group
echo "Creating Resource Group..."
az group create --name $RESOURCE_GROUP --location $LOCATION

# 2. Create Microsoft Entra ID Application (App Registration)
# This is needed for the Bot Framework authentication
echo "Creating Entra ID Application..."
AD_APP=$(az ad app create --display-name "$APP_NAME-identity" --sign-in-audience AzureADMultipleOrgs --web-redirect-uris "https://$APP_NAME-web.azurewebsites.net/api/messages" --output json)
APP_ID=$(echo $AD_APP | jq -r .appId)
OBJECT_ID=$(echo $AD_APP | jq -r .id)

echo "App ID: $APP_ID"

# Reset Credentials to get a Client Secret
echo "Generating Client Secret..."
SECRET_JSON=$(az ad app credential reset --id $APP_ID --display-name "DeploymentSecret" --years 2 --output json)
CLIENT_SECRET=$(echo $SECRET_JSON | jq -r .password)

# 3. Deploy Azure Resources via Bicep
echo "Deploying Infrastructure..."
az deployment group create \
  --resource-group $RESOURCE_GROUP \
  --template-file ../Infrastructure/main.bicep \
  --parameters appName=$APP_NAME location=$LOCATION

# 4. Create Azure Bot Service (Bot Channels Registration)
# This resource links the App ID to the Messaging Endpoint
echo "Creating Azure Bot Service..."
az bot create \
  --resource-group $RESOURCE_GROUP \
  --name "$APP_NAME-bot" \
  --kind webapp \
  --location global \
  --appid $APP_ID \
  --password $CLIENT_SECRET \
  --endpoint "https://$APP_NAME-web.azurewebsites.net/api/messages" \
  --sku F0

# Enables the Microsoft Teams Channel
echo "Enabling Teams Channel..."
az bot msteams create --resource-group $RESOURCE_GROUP --name "$APP_NAME-bot"

# 5. Configure Web App Settings
echo "Configuring Web App Settings..."
az webapp config appsettings set --name "$APP_NAME-web" --resource-group $RESOURCE_GROUP --settings \
    AzureAd:TenantId=$(az account show --query tenantId -o tsv) \
    AzureAd:ClientId=$APP_ID \
    AzureAd:ClientSecret=$CLIENT_SECRET \
    MicrosoftAppType="MultiTenant" \
    MicrosoftAppId=$APP_ID \
    MicrosoftAppPassword=$CLIENT_SECRET \
    SharePoint:SiteId="TODO_REPLACE_WITH_SITE_ID" \
    SharePoint:ListId="TODO_REPLACE_WITH_LIST_ID"

# 6. Build and Deploy Web App (Bot)
echo "Building and Deploying Web App..."
dotnet publish ../MeetingBreakout.WebApp/MeetingBreakout.WebApp.csproj -c Release -o ../publish/web
cd ../publish/web
zip -r ../web.zip .
az webapp deployment source config-zip --resource-group $RESOURCE_GROUP --name "$APP_NAME-web" --src ../web.zip
cd ../../Scripts

# 7. Build and Deploy Function App
echo "Building and Deploying Function App..."
dotnet publish ../MeetingBreakout.Function/MeetingBreakout.Function.csproj -c Release -o ../publish/func
cd ../publish/func
zip -r ../func.zip .

# Flex Consumption Deploy:
# Basic zip deploy works for Flex Consumption if the plan is set up correctly, 
# typically uploading to the configured storage container is preferred but 
# config-zip command handles the upload to a compliant path for many SKUs.
# For strict Flex Consumption compliance, we ensure the 'deployment' property in JSON is respected
# or use `az functionapp deploy` (preview) or config-zip.
az functionapp deployment source config-zip --resource-group $RESOURCE_GROUP --name "$APP_NAME-func" --src ../func.zip
cd ../../Scripts

echo "Bootstrap Complete."
echo "IMPORTANT: You must manually update SharePoint:SiteId and SharePoint:ListId in the Web App Configuration."
