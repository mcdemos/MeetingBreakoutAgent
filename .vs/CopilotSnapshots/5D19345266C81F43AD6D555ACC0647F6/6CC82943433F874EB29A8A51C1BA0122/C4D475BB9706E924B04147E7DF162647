using System;
using System.Collections.Generic;
using System.Threading.Tasks;
using Azure.Identity;
using Microsoft.Extensions.Configuration;
using Microsoft.Graph;
using Microsoft.Graph.Models;

namespace MeetingBreakout.WebApp.Services
{
    public class SharePointService
    {
        private readonly GraphServiceClient _graphClient;
        private readonly string _siteId;
        private readonly string _listId;

        public SharePointService(IConfiguration configuration)
        {
            var tenantId = configuration["AzureAd:TenantId"];
            var clientId = configuration["AzureAd:ClientId"];
            var clientSecret = configuration["AzureAd:ClientSecret"];
            
            _siteId = configuration["SharePoint:SiteId"];
            _listId = configuration["SharePoint:ListId"];

            var options = new ClientSecretCredentialOptions
            {
                AuthorityHost = AzureAuthorityHosts.AzurePublicCloud,
            };

            var clientSecretCredential = new ClientSecretCredential(tenantId, clientId, clientSecret, options);
            _graphClient = new GraphServiceClient(clientSecretCredential);
        }

        public async Task AddBreakoutSelectionAsync(string name, string alias, string option, DateTimeOffset timestamp)
        {
            var listItem = new ListItem
            {
                Fields = new FieldValueSet
                {
                    AdditionalData = new Dictionary<string, object>
                    {
                        { "Title", name },
                        { "Alias", alias },
                        { "OptionSelected", option },
                        { "SelectionTimestamp", timestamp }
                    }
                }
            };

            await _graphClient.Sites[_siteId].Lists[_listId].Items.PostAsync(listItem);
        }
    }
}
