using System;
using System.Collections.Generic;
using System.Linq;
using System.Text.Json;
using System.Text.Json.Nodes;
using System.Threading;
using System.Threading.Tasks;

using Microsoft.Agents.Builder;
using Microsoft.Agents.Builder.Compat;
using Microsoft.Agents.Core.Models;
using Microsoft.Agents.Extensions.Teams.Compat;
using Microsoft.Agents.Extensions.Teams.Connector;
using Microsoft.Agents.Extensions.Teams.Models;

using MeetingBreakout.WebApp.Services;
using RoomService;

namespace MeetingBreakout.WebApp {
  public class BreakoutAgent(SharePointService sharePointService, RoomService.RoomService roomService): TeamsActivityHandler {
    private readonly SharePointService _sharePointService = sharePointService;
    private readonly RoomService.RoomService _roomService = roomService;

    protected override async Task OnMembersAddedAsync(IList<ChannelAccount> membersAdded, ITurnContext<IConversationUpdateActivity> turnContext, CancellationToken cancellationToken) {
      foreach (var member in membersAdded) {
        if (member.Id != turnContext.Activity.Recipient.Id) {
          try {
            var participant = await TeamsInfo.GetMeetingParticipantAsync(turnContext, meetingId: turnContext.Activity.Conversation.Id, participantId: member.Id, cancellationToken: cancellationToken);

            if (participant != null && participant.Meeting.Role != "Organizer") {
              await SendOptionsCardAsync(turnContext, cancellationToken);
            }
          } catch {
            // Fallback or ignore
          }
        }
      }
    }

    protected override async Task OnMessageActivityAsync(ITurnContext<IMessageActivity> turnContext, CancellationToken cancellationToken) {
      if (turnContext.Activity.Value != null) {
        var value = JsonSerializer.SerializeToNode(turnContext.Activity.Value);
        if (value != null && value["option"] != null) {
          string option = value["option"]!.ToString();
          var member = await TeamsInfo.GetMemberAsync(turnContext, turnContext.Activity.From.Id, cancellationToken);
          string name = member?.Name ?? "Unknown";
          string alias = member?.UserPrincipalName ?? "Unknown"; // Approximating alias with UPN, better matches usually available in AAD

          await _sharePointService.AddBreakoutSelectionAsync(name, alias, option, DateTimeOffset.Now);

          if (member == null) {
            await turnContext.SendActivityAsync(MessageFactory.Text("Could not retrieve member details."), cancellationToken);
            return;
          }

          await _roomService.EnsureTableExistsAsync();
          var room = await _roomService.GetFreeRoomAsync(option);

          if (room != null) {
            await _roomService.AssignRoomAsync(room, member.Id, name);
            var link = room.MeetingLink ?? "N/A";
            await turnContext.SendActivityAsync(MessageFactory.Text($"Room assigned: {link}"), cancellationToken);

            await NotifyOrganizersAsync(turnContext, name, link, cancellationToken);
          } else {
            await turnContext.SendActivityAsync(MessageFactory.Text("No free rooms available for this option."), cancellationToken);
          }

          return;
        }
      }

      await base.OnMessageActivityAsync(turnContext, cancellationToken);
    }

    protected override async Task OnTeamsMeetingParticipantsJoinAsync(MeetingParticipantsEventDetails meeting, ITurnContext<IEventActivity> turnContext, CancellationToken cancellationToken) {
      foreach (var member in meeting.Members) {
        await _roomService.UpdatePresenceAsync(turnContext.Activity.Conversation.Id, member.User.Id, isJoining: true);
      }
    }

    protected override async Task OnTeamsMeetingParticipantsLeaveAsync(MeetingParticipantsEventDetails meeting, ITurnContext<IEventActivity> turnContext, CancellationToken cancellationToken) {
      foreach (var member in meeting.Members) {
        // Note: On Leave, member.User might be partial, but ID is usually there.
        await _roomService.UpdatePresenceAsync(turnContext.Activity.Conversation.Id, member.User.Id, isJoining: false);
      }
    }

    private static async Task NotifyOrganizersAsync(ITurnContext turnContext, string assignedUser, string roomLink, CancellationToken cancellationToken) {
      try {
        // Get all members of the current context (Main Meeting)
        // Note: This might be large.
        var members = await TeamsInfo.GetPagedMembersAsync(turnContext, pageSize: 50, cancellationToken: cancellationToken);

        foreach (var member in members.Members) {
          try {
            // Check if Organizer
            var participant = await TeamsInfo.GetMeetingParticipantAsync(turnContext, participantId: member.Id, cancellationToken: cancellationToken);

            if (participant != null && participant.Meeting.Role == "Organizer") {
              var msg = $"User {assignedUser} assigned to Breakout Room: {roomLink}";

              // Send 1:1
              var conversationParameters = new ConversationParameters {
                IsGroup = false,
                Agent = turnContext.Activity.Recipient,
                Members = [member],
                TenantId = turnContext.Activity.Conversation.TenantId
              };

              var channelId = turnContext.Activity.ChannelId;
              var serviceUrl = turnContext.Activity.ServiceUrl;
              var agentId = turnContext.Activity.Recipient?.Id;

              if (string.IsNullOrEmpty(channelId) || string.IsNullOrEmpty(serviceUrl) || string.IsNullOrEmpty(agentId)) {
                continue;
              }

              await ((IChannelAdapter)turnContext.Adapter).CreateConversationAsync(agentId!, channelId!, serviceUrl!, string.Empty, conversationParameters, async (t, c) => { await t.SendActivityAsync(MessageFactory.Text(msg), c); }, cancellationToken);
            }
          } catch {
            // Ignore permission errors or if member left
          }
        }
      } catch (Exception ex) {
        Console.WriteLine($"Notification failed: {ex.Message}");
      }
    }

    private static async Task SendOptionsCardAsync(ITurnContext turnContext, CancellationToken cancellationToken) {
      var cardData = new {
        type = "AdaptiveCard",
        version = "1.4",
        body = new object[] {
          new { type = "TextBlock", text = "Welcome! Please choose a breakout room option:", size = "Medium", weight = "Bolder" }
        },
        actions = new object[] {
          new { type = "Action.Submit", title = "Option 1", data = new { option = "1" } },
          new { type = "Action.Submit", title = "Option 2", data = new { option = "2" } },
          new { type = "Action.Submit", title = "Option 3", data = new { option = "3" } }
        }
      };

      var reply = MessageFactory.Text("");
      reply.Attachments.Add(new Attachment {
        ContentType = "application/vnd.microsoft.card.adaptive",
        Content = cardData
      });

      await turnContext.SendActivityAsync(reply, cancellationToken);
    }
  }
}
