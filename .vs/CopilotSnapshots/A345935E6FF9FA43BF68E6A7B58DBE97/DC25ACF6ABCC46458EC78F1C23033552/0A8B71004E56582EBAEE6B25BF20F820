using System;
using System.Text.Json.Nodes;
using System.Threading;
using System.Threading.Tasks;
using Microsoft.Agents.Builder;
using Microsoft.Agents.Core.Models;
using Microsoft.Agents.Extensions.Teams.Models;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using Moq;
using MeetingBreakout.WebApp.Services;
using RoomService;

namespace MeetingBreakout.WebApp.Tests
{
    [TestClass]
    public class BreakoutAgentTests
    {
        private Mock<ISharePointService> _mockSharePointService = null!;
        private Mock<IRoomService> _mockRoomService = null!;
        private Mock<ITeamsService> _mockTeamsService = null!;
        private BreakoutAgent _agent = null!;

        [TestInitialize]
        public void Setup()
        {
            _mockSharePointService = new Mock<ISharePointService>();
            _mockRoomService = new Mock<IRoomService>();
            _mockTeamsService = new Mock<ITeamsService>();
            _agent = new BreakoutAgent(_mockSharePointService.Object, _mockRoomService.Object, _mockTeamsService.Object);
        }

        [TestMethod]
        public async Task OnMessageActivityAsync_WithOption_AssignsRoom()
        {
            // Arrange
            var turnContextMock = new Mock<ITurnContext>();
            var activity = new Activity
            {
                Type = ActivityTypes.Message,
                Value = new JsonObject { ["option"] = "1" },
                From = new ChannelAccount { Id = "user1" },
                Conversation = new ConversationAccount { Id = "conv1" },
                Recipient = new ChannelAccount { Id = "bot" },
                ChannelId = "msteams"
            };
            
            turnContextMock.Setup(tc => tc.Activity).Returns(activity);

            // Mock response
            turnContextMock.Setup(tc => tc.SendActivityAsync(It.IsAny<IActivity>(), It.IsAny<CancellationToken>()))
                .ReturnsAsync(new ResourceResponse("id"));

            // Mock TeamsService.GetMemberAsync
            var teamsMember = new TeamsChannelAccount { Id = "user1", Name = "Test User", UserPrincipalName = "test@example.com" };
            _mockTeamsService.Setup(ts => ts.GetMemberAsync(It.IsAny<ITurnContext>(), "user1", It.IsAny<CancellationToken>()))
                .ReturnsAsync(teamsMember);

            // Mock RoomService
            var room = new RoomEntity { PartitionKey = "1", RowKey = "room1", MeetingLink = "http://teams.link" };
            _mockRoomService.Setup(rs => rs.GetFreeRoomAsync("1")).ReturnsAsync(room);

            // Mock UpdatePresence (called internally maybe?) No, BreakoutAgent calls EnsureTableExistsAsync and AssignRoomAsync in OnMessageActivityAsync

            // Act
            await _agent.OnTurnAsync(turnContextMock.Object, CancellationToken.None);

            // Assert
            // Verify SharePoint logging
            _mockSharePointService.Verify(sp => sp.AddBreakoutSelectionAsync("Test User", "test@example.com", "1", It.IsAny<DateTimeOffset>()), Times.Once);
            
            // Verify Room Service calls
            _mockRoomService.Verify(rs => rs.EnsureTableExistsAsync(), Times.Once);
            _mockRoomService.Verify(rs => rs.AssignRoomAsync(room, "user1", "Test User"), Times.Once);
            
            // Verify message sent to user
            turnContextMock.Verify(tc => tc.SendActivityAsync(It.Is<IActivity>(a => a.Type == ActivityTypes.Message && ((Activity)a).Text.Contains("Room assigned")), It.IsAny<CancellationToken>()), Times.Once);
        }
    }
}
